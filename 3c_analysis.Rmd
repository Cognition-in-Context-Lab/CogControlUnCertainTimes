---
title: "3C Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Packages
library(psych)
library(tidyverse)
library(ggplot2)
#library(dplyr)
#library(plyr)
```


## Load and Cleanup Data
```{r}
#df <- read.csv("C:/Users/14083/Desktop/3C_Live_Study_NA_Data.csv")
df <- read.csv("C:/Users/14083/Desktop/3C_Live_Study_Data.csv", header=T, na.strings="")
#df <- read.csv("3C_Live_Study_NA_Data.csv")

# Drop unneeded rows (pilot data, incomplete trials,remove entries that are shorter than 6 mins longer than 60 minutes) & cols
unneeded_cols <- c("StartDate", "EndDate", "Status", "IPAddress", "Progress", "Finished", "RecordedDate", "ResponseId", "RecipientLastName", "RecipientFirstName", "RecipientEmail", "ExternalReference", "LocationLatitude", "LocationLongitude", "DistributionChannel", "UserLanguage", "Gender_4_TEXT...Parent.Topics", "Gender_4_TEXT...Sentiment.Polarity", "Gender_4_TEXT...Sentiment.Score", "Gender_4_TEXT...Sentiment", "Gender_4_TEXT...Topics", "Gender_4_TEXT...Topic.Sentiment.Label", "Gender_4_TEXT...Topic.Sentiment.Score")

# Return entries where duration was longer than 45 min.
df$'Duration..in.seconds.' = as.numeric(as.character(df$'Duration..in.seconds.'))
df[which(df$'Duration..in.seconds.' >= 45*60), ]

# return entries where duration was shorter than 6 mins.
df$'Duration..in.seconds.' = as.numeric(as.character(df$'Duration..in.seconds.'))
df[which(df$'Duration..in.seconds.' <= 360), ]

# remove Gender and Race open response columns to be able to remove rows with missing values
NAcols <- c("Gender_4_TEXT", "Race_6_TEXT")

df <- df[-c(1:7,8:12,22,205,222,255,324,415:444), ]
df <- df[ , !names(df) %in% unneeded_cols]
df <- df[ , !names(df) %in% NAcols]
```

## Creating COVID19 DoG Index 
# Andrew/Kate decided placement should be above removing NAs, not working in reverse order
#Add columns with time frames in days

```{r}
# saving both response in set of units (days-years), (.2_x) AND numbers (0-30), (.1_x)
dog1 <- list("COVID_DoG_Questions.1", df$COVID_DoG_Questions.2_1, df$COVID_DoG_Questions.1_1)
dog2 <- list("COVID_DoG_Questions.2", df$COVID_DoG_Questions.2_2, df$COVID_DoG_Questions.1_2)
dog3 <- list("COVID_DoG_Questions.3", df$COVID_DoG_Questions.2_3, df$COVID_DoG_Questions.1_3)
dog4 <- list("COVID_DoG_Questions.4", df$COVID_DoG_Questions.2_4, df$COVID_DoG_Questions.1_4)
dog5 <- list("COVID_DoG_Questions.5", df$COVID_DoG_Questions.2_5, df$COVID_DoG_Questions.1_5)
dog6 <- list("COVID_DoG_Questions.6", df$COVID_DoG_Questions.2_6, df$COVID_DoG_Questions.1_6)

# saving both response in set of units (days-years), (.1_x) AND numbers (0-30), (.2_x)
pandemic_len <- list("PandemicLengthExpect.1", df$PandemicLengthExpect.1_1, df$PandemicLengthExpect.2_1)

## create function called create_columns that takes in UNITS and NUMBERS
# depending on units, multiplies NUMBERS by correct converstion to have units ALL in days
# e.g. 2 = weeks, so NUMBER (len_col) x 7 = days 
# fixed from (units_col, 1, 1) to (units_col, 1, 2) because NUMBERS that were more than 1 digit (e.g. 11, 13) were being cut off 
# so 11 months was being converted to 30 days not 330 days
create_columns <- function(units_col, len_col) {
  case_when(as.numeric(substring(units_col, 1, 2)) == 1 ~ as.numeric(substring(len_col, 1, 2)) * 1,
            as.numeric(substring(units_col, 1, 2)) == 2 ~ as.numeric(substring(len_col, 1, 2)) * 7,
            as.numeric(substring(units_col, 1, 2)) == 3 ~ as.numeric(substring(len_col, 1, 2)) * 30,
            as.numeric(substring(units_col, 1, 2)) == 4 ~ as.numeric(substring(len_col, 1, 2)) * 365)
}

## work to debug create_columns function
# test each of the functions in create_columns
#units_col = 12
#units <- substring(units_col, 1, 1)
#units
# prints out 1 when should print out 12
# function not taking the entire number (13)
#solution: change as.numeric(substring((units_col, 1, 1)) to (units_col, 1, 2)))

# loop through 6 categories saved above and apply function
df <- df %>% mutate(!!dog1[[1]] := create_columns(dog1[[2]], dog1[[3]]),
              !!dog2[[1]] := create_columns(dog2[[2]], dog2[[3]]),
              !!dog3[[1]] := create_columns(dog3[[2]], dog3[[3]]),
              !!dog4[[1]] := create_columns(dog4[[2]], dog4[[3]]),
              !!dog5[[1]] := create_columns(dog5[[2]], dog5[[3]]),
              !!dog6[[1]] := create_columns(dog6[[2]], dog6[[3]]),
              !!pandemic_len[[1]] := create_columns(pandemic_len[[2]], pandemic_len[[3]]),
              .before = SocialNorms_Family_1
              )

#checks: are lengths the same?
#length(pandemic_len[[2]])
#length(pandemic_len[[3]])
#df %>% select(PandemicLengthExpect.1_1, PandemicLengthExpect.2_1, PandemicLengthExpect.1)

#view(df)
```

## Remove missing values and convert classes
```{r}
#check where the missing values are
#rowSums(is.na(df))

#remove missing values
##show where missing values are
df[!complete.cases(df), ]
##create new dataset with no missing values
omit_df <- na.omit(df)
#view(omit_df)
sum(is.na(omit_df))

#convert character values (except Nationality and Occupation) to numeric to be able to calculate stats
numeric_cols1 <- names(omit_df)[3:206] #ends on Race 
numeric_cols2 <- names(omit_df)[208] #education
numeric_cols3 <- names(omit_df)[210:224] #begins on Measure2_2 to end of columns

#view(omit_df)

omit_df[numeric_cols1] <- lapply(omit_df[numeric_cols1], as.numeric)
omit_df[numeric_cols2] <- lapply(omit_df[numeric_cols2], as.numeric)
omit_df[numeric_cols3] <- lapply(omit_df[numeric_cols3], as.numeric)

sapply(omit_df, class) # all numeric!

#view(omit_df)

#check that everyone included in omit_df passed both attention checks
omit_df$attentioncheck_1 #all 4s
omit_df$attentioncheck_2 #all 3s

# recode value in Age variable that participant entered their birth year (1971) instead of their age
which(omit_df == 1971, arr.ind=TRUE)
# row = 232, col = 202
omit_df[232,202] <- 2021-1971
omit_df[232,202]

```

## Demographics Analyses
```{r}
#duration, demographics
mean(df$Duration..in.seconds., na.rm = TRUE)
mean(omit_df$Duration..in.seconds.)
sd(omit_df$Duration..in.seconds.)

summary(omit_df$Age)
table(omit_df$Gender)
table(omit_df$Race)
table(omit_df$Education)
```

## Add summary columns to calculate descriptive statistics
# Placed before Summary statistics because summary columns required for calculations

# Perceived Risk and Value
```{r}
mini_df <- omit_df %>% select(PerceivedRisk_1:PerceivedRisk_6)
#mini_df
omit_df <- omit_df %>% mutate(Perceived_Risk_Sum = rowSums(mini_df), .before = PerceivedValue_1)
omit_df$Perceived_Risk_Sum
mini_df <- omit_df %>% select(PerceivedValue_1:PerceivedValue_6)
omit_df <- omit_df %>% mutate(Perceived_Value_Sum = rowSums(mini_df), .before = GCS_1)
view(omit_df)
```

# COVID DoG
```{r}
mini_df <- omit_df %>% select(COVID_DoG_Questions.1:COVID_DoG_Questions.6)
omit_df <- omit_df %>% mutate(COVID_DoG_Sum = rowSums(mini_df), .before = PandemicLengthExpect.1)
summary(omit_df$COVID_DoG_Sum)
# make index of delaying across all 6 categories (average delaying across categories)
omit_df <- omit_df %>% mutate(COVID_DoG_index = rowMeans(mini_df), .before = PandemicLengthExpect.1)
#create 1 index across social situations/gatherings and 1 index across traveling
view(omit_df)
mini_df <- omit_df %>% select(COVID_DoG_Questions.1:COVID_DoG_Questions.3)
omit_df <- omit_df %>% mutate(socialgatherings_index = rowMeans(mini_df), .before = PandemicLengthExpect.1)
mini_df <- omit_df %>% select(COVID_DoG_Questions.4:COVID_DoG_Questions.6)
omit_df <- omit_df %>% mutate(traveling_index = rowMeans(mini_df), .before = PandemicLengthExpect.1)


#view(omit_df)
```

# MCQ
```{r}
mini_df <- omit_df %>% select(MCQ_1:MCQ_27)
omit_df <- omit_df %>% mutate(MCQ_Sum = rowSums(mini_df), .before = COVID_DoG_Questions.1_1)
```

# Social Norms
```{r}
mini_df <- omit_df %>% select(SocialNorms_Family_1:SocialNorms_Stranger_3)
omit_df <- omit_df %>% mutate(Norms_Sum = rowSums(mini_df), .before = PerceivedRisk_1)
```

# General Confidence
```{r}
mini_df <- omit_df %>% select(contains("GCS"))
#mini_df
omit_df <- omit_df %>% mutate(GCS_Sum = rowSums(mini_df), .before = IUS_1)
omit_df$GCS_Sum
#view(omit_df)
```

# Intolerance of Uncertainty
```{r}
mini_df <- omit_df %>% select(IUS_1:IUS_12)
omit_df <- omit_df %>% mutate(IUS_Sum = rowSums(mini_df), .before = MFQpart1_1)
```

# Political Orientation
```{r}
# measure 2
mini_df <- omit_df %>% select(Measure2_2:Measure2_4)
omit_df <- omit_df %>% mutate(Measure2_PO_Sum = rowSums(mini_df), .before = Measure5_1)
# measure 5
mini_df <- omit_df %>% select(Measure5_1:Measure5_14)
omit_df <- omit_df %>% mutate(Measure5_PO_Sum = rowSums(mini_df))
#combining both measures
mini_df <- omit_df %>% select(contains("PO_Sum"))
#mini_df
omit_df <- omit_df %>% mutate(PO_Total_Sum = rowSums(mini_df))
```

# MFQ
```{r}
MFQ_part1 <- omit_df %>% select(MFQpart1_1:MFQpart1_16)
MFQ_part2 <- omit_df %>% select(MFQ_part2_1:MFQ_part2_16)
omit_df <- omit_df %>% mutate(MFQ_sum_part1 = rowSums(MFQ_part1), .before = MFQ_part2_1)
omit_df <- omit_df %>% mutate(MFQ_sum_part2 = rowSums(MFQ_part2), .before = Disgust_1)
view(omit_df)
MFQ_total <- omit_df %>% select(contains("MFQ_sum"))
#MFQ_total
omit_df <- omit_df %>% mutate(MFQ_total_sum = rowSums(MFQ_total), .before = Disgust_1)
```

# COVID Stress
```{r}
mini_df <- omit_df %>% select(contains("Worries") | contains("Problems") | contains("Checking"))
#mini_df
omit_df <- omit_df %>% mutate(Stress_Sum = rowSums(mini_df), .before = Impacts_financial1)
```

# COVID Impacts and Experiences
```{r}
Impacts <- omit_df %>% select(Impacts_financial1:Impacts_psychology3)
Experiences <- omit_df %>% select(contains("PersonalDiagnoses") | contains("Proximity") | contains("News"))
#Experiences
omit_df <- omit_df %>% mutate(Impacts_sum = rowSums(Impacts), .before = PersonalDiagnoses_1)
omit_df <- omit_df %>% mutate(Experiences_sum = rowSums(Experiences), .before = Age)
```

# Disgust
```{r}
mini_df <- omit_df %>% select(Disgust_1:Disgust_21)
omit_df <- omit_df %>% mutate(Disgust_Sum = rowSums(mini_df), .before = SDRS.5_Q1)
```

# Social Desirability
```{r}
mini_df <- omit_df %>% select(SDRS.5_Q1:SDRS.5_Q5)
omit_df <- omit_df %>% mutate(SDRS_Sum = rowSums(mini_df), .before = Worries_1)
#view(omit_df)
```

# Summary statistics
```{r}
summary(omit_df$PandemicLengthExpect.1)
describe(omit_df$COVID_DoG_Sum)
describe(omit_df$MCQ_Sum)
describe(omit_df$Norms_Sum)
describe(omit_df$GCS_Sum)
describe(omit_df$IUS_Sum)
describe(omit_df$MFQ_sum_part1)
describe(omit_df$MFQ_sum_part2)
describe(omit_df$MFQ_total_sum)
describe(omit_df$Disgust_Sum)
describe(omit_df$Perceived_Value_Sum)
describe(omit_df$SDRS_Sum)
describe(omit_df$Impacts_sum)
describe(omit_df$Experiences_sum)
describe(omit_df$Stress_Sum)
describe(omit_df$MFQ_total_sum)
describe(omit_df$Measure2_PO_Sum)
describe(omit_df$Measure5_PO_Sum)
describe(omit_df$PO_Total_Sum)
describe(omit_df$Perceived_Risk_Sum)
```

# Graphs
```{r}
##Demographics
#Age
hist(omit_df$Age)

#Gender
# 1) create new variable with gender recoded as a factor
omit_df$GenderasFactor <- factor(omit_df$Gender, levels=1:8, labels=c("male", "female", "non-binary", "other", "prefer not to answer", "trans man", "trans woman", "genderqueer"))
# 2) create barplot with new Gender variable
ggplot(omit_df) +
  geom_bar(aes(x = GenderasFactor)) +
  ggtitle("Count of Gender") +
  theme(plot.title = element_text(hjust = 0.5))

#Education
omit_df$EducationasFactor <- factor(omit_df$Education, levels=1:6, labels=c("Unknown","No hs diploma","No college","Some college","4 yr college","Graduate degree"))
ggplot(omit_df) +
  geom_bar(aes(x = EducationasFactor)) +
  ggtitle("Count of Education") +
  theme(plot.title = element_text(hjust = 0.5))

#Race
omit_df$RaceasFactor <- factor(omit_df$Race, levels=1:7, labels=c("Am Indian","Asian","Pacific Islander","Black","White","Multiple","Unknown"))
ggplot(omit_df) +
  geom_bar(aes(x = RaceasFactor)) +
  ggtitle("Count of Race") +
  theme(plot.title = element_text(hjust = 0.5))

# Plot for COVID DoG index (average delaying across 6 scenarios for each participant)
hist(omit_df$COVID_DoG_index)

# Relations between variables
#ggplot(data = omit_df) + 
  #geom_point(mapping = aes(x = COVID_DoG_Sum, y = Perceived_Risk_Sum))

```

## Task Analyses
# COVID DoG and Perceived Risk/Value
```{r}
hist(omit_df$socialgatherings_index)
summary(omit_df$socialgatherings_index)
hist(omit_df$traveling_index)
summary(omit_df$traveling_index)

#Question: are there data driven differences between the two indices (social gatherings and traveling)? E.g. days in one versus months in other
socialgatherings_length <- omit_df %>% select(COVID_DoG_Questions.2_1:COVID_DoG_Questions.2_3)
summary(rowMeans(socialgatherings_length))
traveling_length <- omit_df %>% select(COVID_DoG_Questions.2_4:COVID_DoG_Questions.2_6)
summary(rowMeans(traveling_length))
#Answer: it doesn't look like there's differences between them, both have similar means? (2.608 v. 3.094) - rounds to 3, thus the average length response for both indices was in months

#perform EFA to see if there are two separate factors for DoG that pertain to travel and social situations/gatherings that influence how participants respond? This would answer the question to whatever or not we should keep the things separate or together
#EFA steps:
##basic factor analysis model: y = (lambda)(f) + (u) 
#y = individual's score on observed variable
#lambda = factor loading indicating relation between observed variable and latent common factor
#f = individual's score on latent common factor
#u = individual's score on latent unique factor

# Future plans:
#index: Expectation of Pandemic; May help us evaluate how folks expectations relate to their DoG index + that relationship may be meaningful across other analyses
#perform tests with other variables (e.g. general uncertainty) 3 times:
#1) DoG Index by itself
#2) Index:Expectation of Pandemic
#3) Both indices
```

# COVID DoG and General Uncertainty
```{r}
# normality assumption
shapiro.test(omit_df$GCS_Sum)

```